<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="PDF Audio Player">
<title>PDF Audio Player</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js"></script>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
-webkit-tap-highlight-color: transparent;
-webkit-touch-callout: none;
}
:root {
--bg-gradient-start: #f5f5f7;
--bg-gradient-mid: #fafafa;
--bg-gradient-end: #f0f0f2;
--glass-bg: rgba(255, 255, 255, 0.7);
--glass-border: rgba(255, 255, 255, 0.3);
--card-bg: rgba(255, 255, 255, 0.8);
--card-border: rgba(255, 255, 255, 0.5);
--text-primary: rgba(0, 0, 0, 0.8);
--text-secondary: rgba(0, 0, 0, 0.6);
--text-tertiary: rgba(0, 0, 0, 0.4);
--input-bg-start: rgba(255, 255, 255, 0.9);
--input-bg-end: rgba(255, 255, 255, 0.7);
--viewer-bg: rgba(255, 255, 255, 0.5);
--shadow-color: rgba(0, 0, 0, 0.1);
--inset-shadow: rgba(255, 255, 255, 0.8);
--slider-track: rgba(174, 174, 178, 0.3);
--slider-thumb: #86868b;
--slider-thumb-shadow: rgba(134, 134, 139, 0.3);
}
body.dark-mode {
--bg-gradient-start: #1c1c1e;
--bg-gradient-mid: #2c2c2e;
--bg-gradient-end: #1c1c1e;
--glass-bg: rgba(44, 44, 46, 0.8);
--glass-border: rgba(84, 84, 88, 0.3);
--card-bg: rgba(58, 58, 60, 0.8);
--card-border: rgba(84, 84, 88, 0.5);
--text-primary: rgba(255, 255, 255, 0.9);
--text-secondary: rgba(255, 255, 255, 0.6);
--text-tertiary: rgba(255, 255, 255, 0.4);
--input-bg-start: rgba(58, 58, 60, 0.9);
--input-bg-end: rgba(44, 44, 46, 0.7);
--viewer-bg: rgba(28, 28, 30, 0.6);
--shadow-color: rgba(0, 0, 0, 0.3);
--inset-shadow: rgba(84, 84, 88, 0.3);
--slider-track: rgba(84, 84, 88, 0.5);
--slider-thumb: #98989d;
--slider-thumb-shadow: rgba(152, 152, 157, 0.3);
}
body {
font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', sans-serif;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
overflow: hidden;
background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 50%, var(--bg-gradient-end) 100%);
padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
}
.app-container {
display: flex;
flex-direction: column;
height: 100vh;
height: 100dvh;
gap: 0;
}
.sidebar {
background: var(--glass-bg);
backdrop-filter: blur(40px) saturate(180%);
-webkit-backdrop-filter: blur(40px) saturate(180%);
border-bottom: 1px solid var(--glass-border);
box-shadow: 0 8px 32px var(--shadow-color), inset 0 1px 0 var(--inset-shadow);
padding: 16px;
overflow-y: auto;
-webkit-overflow-scrolling: touch;
transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.sidebar.collapsed {
height: auto !important;
}
.sidebar.collapsed .collapsible-content {
display: none;
}
@media (min-width: 768px) {
.sidebar.collapsed {
width: auto;
padding: 20px;
}
}
.toggle-button {
display: block;
background: var(--card-bg);
backdrop-filter: blur(20px);
-webkit-backdrop-filter: blur(20px);
border: 1px solid var(--card-border);
border-radius: 12px;
padding: 12px;
margin-bottom: 12px;
cursor: pointer;
font-weight: 600;
font-size: 15px;
color: var(--text-primary);
box-shadow: 0 4px 16px var(--shadow-color);
transition: all 0.2s ease;
text-align: center;
}
.toggle-button:active {
transform: scale(0.98);
}
.dark-mode-toggle {
background: var(--card-bg);
backdrop-filter: blur(20px);
-webkit-backdrop-filter: blur(20px);
border: 1px solid var(--card-border);
border-radius: 12px;
padding: 10px;
cursor: pointer;
font-size: 20px;
box-shadow: 0 4px 16px var(--shadow-color);
transition: all 0.2s ease;
display: inline-flex;
align-items: center;
justify-content: center;
width: 44px;
height: 44px;
border: none;
}
.dark-mode-toggle:active {
transform: scale(0.95);
}
.header-with-toggle {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 8px;
}
.main-viewer {
flex: 1;
overflow-y: auto;
background: var(--viewer-bg);
backdrop-filter: blur(60px) saturate(150%);
-webkit-backdrop-filter: blur(60px) saturate(150%);
padding: 20px;
-webkit-overflow-scrolling: touch;
box-shadow: inset 0 1px 0 var(--inset-shadow);
}
h1 {
font-size: 32px;
font-weight: 700;
color: var(--text-primary);
letter-spacing: -0.5px;
margin-bottom: 0;
}
.subtitle {
font-size: 15px;
color: var(--text-secondary);
font-weight: 400;
line-height: 1.4;
margin-bottom: 16px;
}
.input-card {
background: var(--card-bg);
backdrop-filter: blur(20px) saturate(180%);
-webkit-backdrop-filter: blur(20px) saturate(180%);
border-radius: 16px;
border: 1px solid var(--card-border);
padding: 14px;
margin-bottom: 12px;
box-shadow: 0 4px 16px var(--shadow-color), inset 0 1px 0 var(--inset-shadow);
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.input-card:active {
transform: scale(0.98);
box-shadow: 0 2px 8px var(--shadow-color), inset 0 1px 0 var(--inset-shadow);
}
.input-label {
display: block;
font-weight: 600;
font-size: 13px;
color: var(--text-secondary);
margin-bottom: 8px;
text-transform: uppercase;
letter-spacing: 0.5px;
}
.file-inputs-combined {
display: flex;
flex-direction: column;
gap: 12px;
}
.file-input-row {
display: flex;
align-items: center;
gap: 10px;
padding: 10px;
background: var(--input-bg-start);
border-radius: 10px;
border: 1px dashed var(--card-border);
transition: all 0.2s ease;
cursor: pointer;
}
.file-input-row:active {
background: var(--input-bg-end);
border-color: var(--text-tertiary);
}
.file-input-icon {
font-size: 20px;
flex-shrink: 0;
}
.file-input-wrapper {
flex: 1;
min-width: 0;
}
.file-input-label {
font-size: 11px;
font-weight: 600;
color: var(--text-tertiary);
text-transform: uppercase;
letter-spacing: 0.5px;
margin-bottom: 2px;
}
.file-input-name {
font-size: 13px;
font-weight: 500;
color: var(--text-primary);
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
}
input[type="file"] {
display: none;
}
audio {
width: 100%;
height: 54px;
border-radius: 14px;
background: var(--card-bg);
backdrop-filter: blur(20px);
-webkit-backdrop-filter: blur(20px);
box-shadow: 0 4px 16px var(--shadow-color), inset 0 1px 0 var(--inset-shadow);
}
.info-card {
background: linear-gradient(135deg, var(--card-bg) 0%, var(--card-bg) 100%);
backdrop-filter: blur(30px) saturate(180%);
-webkit-backdrop-filter: blur(30px) saturate(180%);
border-radius: 16px;
border: 1px solid var(--card-border);
padding: 16px;
margin: 12px 0;
box-shadow: 0 8px 24px var(--shadow-color), inset 0 1px 0 var(--inset-shadow);
}
.zoom-controls {
display: flex;
align-items: center;
justify-content: space-between;
gap: 12px;
}
.zoom-label {
font-weight: 600;
font-size: 15px;
color: var(--text-primary);
flex-shrink: 0;
}
.zoom-buttons {
display: flex;
gap: 8px;
}
.zoom-button {
background: var(--card-bg);
backdrop-filter: blur(20px);
-webkit-backdrop-filter: blur(20px);
border: 1px solid var(--card-border);
border-radius: 10px;
width: 44px;
height: 44px;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
font-size: 20px;
font-weight: 600;
color: var(--text-primary);
box-shadow: 0 2px 8px var(--shadow-color);
transition: all 0.2s ease;
-webkit-user-select: none;
user-select: none;
}
.zoom-button:active {
transform: scale(0.95);
box-shadow: 0 1px 4px var(--shadow-color);
}
.zoom-value {
background: var(--card-bg);
padding: 8px 16px;
border-radius: 10px;
font-weight: 700;
font-size: 15px;
color: var(--text-primary);
backdrop-filter: blur(10px);
-webkit-backdrop-filter: blur(10px);
box-shadow: inset 0 1px 0 var(--inset-shadow);
border: 1px solid var(--card-border);
min-width: 60px;
text-align: center;
}
.status-box {
padding: 14px 16px;
border-radius: 14px;
margin: 16px 0;
font-size: 14px;
display: flex;
align-items: center;
gap: 10px;
font-weight: 500;
backdrop-filter: blur(20px) saturate(180%);
-webkit-backdrop-filter: blur(20px) saturate(180%);
border: 1px solid var(--card-border);
box-shadow: 0 4px 16px var(--shadow-color), inset 0 1px 0 var(--inset-shadow);
}
.status-loading {
background: var(--card-bg);
color: var(--text-primary);
}
.status-success {
background: linear-gradient(135deg, rgba(52, 199, 89, 0.15) 0%, rgba(52, 199, 89, 0.1) 100%);
color: rgba(30, 132, 73, 1);
}
.status-error {
background: linear-gradient(135deg, rgba(255, 59, 48, 0.15) 0%, rgba(255, 59, 48, 0.1) 100%);
color: rgba(215, 0, 21, 1);
}
input[type="range"] {
-webkit-appearance: none;
width: 100%;
height: 6px;
border-radius: 6px;
background: var(--slider-track);
outline: none;
margin: 12px 0;
box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
}
input[type="range"]::-webkit-slider-thumb {
-webkit-appearance: none;
appearance: none;
width: 24px;
height: 24px;
border-radius: 50%;
background: var(--slider-thumb);
cursor: pointer;
box-shadow: 0 2px 6px var(--slider-thumb-shadow), 0 0 0 3px var(--card-bg);
transition: all 0.2s ease;
}
input[type="range"]::-webkit-slider-thumb:active {
transform: scale(1.1);
box-shadow: 0 3px 10px var(--slider-thumb-shadow), 0 0 0 4px var(--card-bg);
}
input[type="range"]::-moz-range-thumb {
width: 24px;
height: 24px;
border-radius: 50%;
background: var(--slider-thumb);
cursor: pointer;
border: none;
box-shadow: 0 2px 6px var(--slider-thumb-shadow), 0 0 0 3px var(--card-bg);
}
.page-container {
position: relative;
margin: 16px auto;
border-radius: 16px;
overflow: hidden;
box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(255, 255, 255, 0.5);
touch-action: pan-y;
background: white;
backdrop-filter: blur(40px);
-webkit-backdrop-filter: blur(40px);
transition: transform 0.2s ease;
}
.highlight-overlay {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
pointer-events: none;
}
.highlight-overlay.hidden {
display: none;
}
canvas {
display: block;
width: 100%;
height: 100%;
}
.highlight-box {
position: absolute;
background: rgba(255, 214, 10, 0.35);
border-radius: 2px;
transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
box-sizing: border-box;
left: 0;
width: 100%;
padding-top: 6px;
padding-bottom: 6px;
}
.page-badge {
display: inline-flex;
align-items: center;
gap: 8px;
font-size: 14px;
color: var(--text-primary);
margin-bottom: 8px;
font-weight: 500;
}
.page-number {
background: var(--card-bg);
padding: 4px 12px;
border-radius: 8px;
font-weight: 700;
backdrop-filter: blur(10px);
-webkit-backdrop-filter: blur(10px);
box-shadow: inset 0 1px 0 var(--inset-shadow);
border: 1px solid var(--card-border);
}
.placeholder {
text-align: center;
padding: 80px 20px;
color: var(--text-tertiary);
}
.placeholder svg {
width: 80px;
height: 80px;
margin: 0 auto 24px;
opacity: 0.3;
filter: drop-shadow(0 4px 8px var(--shadow-color));
}
.placeholder-title {
font-size: 22px;
font-weight: 700;
margin-bottom: 8px;
color: var(--text-secondary);
}
.placeholder-subtitle {
font-size: 15px;
font-weight: 400;
color: var(--text-tertiary);
}
@keyframes liquid-spin {
0% { transform: rotate(0deg) scale(1); }
50% { transform: rotate(180deg) scale(1.05); }
100% { transform: rotate(360deg) scale(1); }
}
.spinner {
width: 20px;
height: 20px;
border: 3px solid rgba(255, 255, 255, 0.3);
border-top-color: currentColor;
border-radius: 50%;
animation: liquid-spin 1s cubic-bezier(0.4, 0, 0.2, 1) infinite;
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}
.speed-label {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 8px;
color: var(--text-primary);
}
.speed-value {
background: var(--card-bg);
padding: 4px 14px;
border-radius: 10px;
font-weight: 700;
font-size: 15px;
color: var(--text-primary);
backdrop-filter: blur(10px);
-webkit-backdrop-filter: blur(10px);
box-shadow: inset 0 1px 0 var(--inset-shadow);
border: 1px solid var(--card-border);
}
body.dark-mode .speed-value {
color: var(--text-primary);
}
.toggle-switch {
position: relative;
display: inline-block;
width: 51px;
height: 31px;
flex-shrink: 0;
}
.toggle-switch input {
opacity: 0;
width: 0;
height: 0;
}
.toggle-slider {
position: absolute;
cursor: pointer;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: var(--slider-track);
transition: 0.3s;
border-radius: 31px;
box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}
.toggle-slider:before {
position: absolute;
content: "";
height: 23px;
width: 23px;
left: 4px;
bottom: 4px;
background: white;
transition: 0.3s;
border-radius: 50%;
box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}
input:checked + .toggle-slider {
background: #34c759;
}
input:checked + .toggle-slider:before {
transform: translateX(20px);
}
.toggle-row {
display: flex;
justify-content: space-between;
align-items: center;
gap: 12px;
}
.toggle-label-text {
font-weight: 600;
font-size: 15px;
color: var(--text-primary);
flex-grow: 1;
}
@media (min-width: 768px) {
.app-container {
flex-direction: row;
}
.sidebar {
width: 420px;
flex-shrink: 0;
height: 100vh;
height: 100dvh;
border-bottom: none;
border-right: 1px solid var(--glass-border);
box-shadow: 8px 0 32px var(--shadow-color), inset -1px 0 0 var(--inset-shadow);
}
.main-viewer {
padding: 40px;
}
h1 {
font-size: 38px;
}
}
@media (min-width: 768px) and (orientation: landscape) {
.sidebar {
width: 440px;
}
}
.overflow-y-auto {
-webkit-overflow-scrolling: touch;
overscroll-behavior: contain;
scroll-behavior: smooth;
}
label, h1, .subtitle, .status-box, .page-badge {
-webkit-user-select: none;
user-select: none;
}
.main-viewer {
-webkit-user-select: text;
user-select: text;
}
</style>
</head>
<body>
<div class="app-container">
<aside class="sidebar" id="sidebar">
<div class="toggle-button" id="toggle-button">
<span id="toggle-text">⌃ Show Controls</span>
</div>
<div style="margin-bottom: 12px;" id="collapsed-audio">
<audio id="audio-player" controls disabled></audio>
</div>
<div class="collapsible-content">
<div class="header-with-toggle">
<h1>PDF Audio Player</h1>
<button class="dark-mode-toggle" id="dark-mode-toggle" title="Toggle Dark Mode">
<span id="theme-icon">🌙</span>
</button>
</div>
<p class="subtitle">Upload files for synchronized playback with highlighting</p>
<div class="input-card">
<label class="input-label">Upload Files</label>
<div class="file-inputs-combined">
<label class="file-input-row" for="pdf-file">
<span class="file-input-icon">📄</span>
<div class="file-input-wrapper">
<div class="file-input-label">PDF Document</div>
<div class="file-input-name" id="pdf-file-name">No file selected</div>
</div>
</label>
<input type="file" id="pdf-file" accept=".pdf,application/pdf">
<label class="file-input-row" for="mp3-file">
<span class="file-input-icon">🎵</span>
<div class="file-input-wrapper">
<div class="file-input-label">Audio File</div>
<div class="file-input-name" id="mp3-file-name">No file selected</div>
</div>
</label>
<input type="file" id="mp3-file" accept=".mp3,audio/mpeg,audio/*">
<label class="file-input-row" for="json-file">
<span class="file-input-icon">📋</span>
<div class="file-input-wrapper">
<div class="file-input-label">JSON Manifest</div>
<div class="file-input-name" id="json-file-name">No file selected</div>
</div>
</label>
<input type="file" id="json-file" accept=".json,application/json">
</div>
</div>
<div id="status-box" class="status-box status-loading" style="display: none;">
<div id="loading-spinner" class="spinner"></div>
<span id="status-message">Loading...</span>
</div>
<div class="info-card">
<div class="speed-label">
<span style="font-weight: 600; font-size: 15px;">Playback Speed</span>
<span id="speed-value" class="speed-value">1.0x</span>
</div>
<input type="range" id="speed-slider" min="0.5" max="2.0" step="0.1" value="1.0">
<div class="toggle-row" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--card-border);">
<span class="toggle-label-text">Show Highlighter</span>
<label class="toggle-switch">
<input type="checkbox" id="highlighter-toggle" checked>
<span class="toggle-slider"></span>
</label>
</div>
<div class="zoom-controls" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--card-border);">
<span class="zoom-label">PDF Zoom</span>
<div style="display: flex; align-items: center; gap: 8px;">
<span id="zoom-value" class="zoom-value">100%</span>
<div class="zoom-buttons">
<button class="zoom-button" id="zoom-out" title="Zoom Out">−</button>
<button class="zoom-button" id="zoom-in" title="Zoom In">+</button>
</div>
</div>
</div>
</div>
<div class="info-card">
<div class="page-badge" id="audio-page-display">
📖 Reading: <span class="page-number">-</span>
</div>
<div class="page-badge" id="user-page-display">
👁️ Viewing: <span class="page-number">-</span>
</div>
</div>
</div>
</aside>
<main class="main-viewer" id="pdf-viewer">
<div id="pdf-container">
<div id="viewer-placeholder" class="placeholder">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
<path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
</svg>
<div class="placeholder-title">No Document Loaded</div>
<div class="placeholder-subtitle">Upload a PDF file to begin</div>
</div>
</div>
</main>
</div>
<script>
let pdfDoc = null;
let manifest = null;
let pageViewports = {};
let inferredPageDims = {};
let audioPlayer = document.getElementById('audio-player');
let pdfContainer = document.getElementById('pdf-container');
let viewerPlaceholder = document.getElementById('viewer-placeholder');
let statusBox = document.getElementById('status-box');
let statusMessage = document.getElementById('status-message');
let loadingSpinner = document.getElementById('loading-spinner');
let audioPageDisplay = document.getElementById('audio-page-display');
let userPageDisplay = document.getElementById('user-page-display');
let speedSlider = document.getElementById('speed-slider');
let speedValueDisplay = document.getElementById('speed-value');
let highlighterToggle = document.getElementById('highlighter-toggle');
let currentHighlight = null;
let currentHighlightSentence = null;
let currentAudioPage = null;
let currentUserPage = null;
let pdfScale = 1.5;
let fileTracker = { pdf: false, mp3: false, json: false };
let intersectionObserver = null;
let zoomLevel = 100;
let highlighterEnabled = true;
const zoomStep = 25;
const minZoom = 50;
const maxZoom = 200;
const zoomInButton = document.getElementById('zoom-in');
const zoomOutButton = document.getElementById('zoom-out');
const zoomValueDisplay = document.getElementById('zoom-value');
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
const darkModeToggle = document.getElementById('dark-mode-toggle');
const themeIcon = document.getElementById('theme-icon');
const currentTheme = localStorage.getItem('theme');
if (currentTheme === 'dark') {
document.body.classList.add('dark-mode');
themeIcon.textContent = '☀️';
}
darkModeToggle.addEventListener('click', () => {
document.body.classList.toggle('dark-mode');
const isDark = document.body.classList.contains('dark-mode');
themeIcon.textContent = isDark ? '☀️' : '🌙';
localStorage.setItem('theme', isDark ? 'dark' : 'light');
});
highlighterToggle.addEventListener('change', (e) => {
highlighterEnabled = e.target.checked;
const overlays = document.querySelectorAll('.highlight-overlay');
overlays.forEach(overlay => {
if (highlighterEnabled) {
overlay.classList.remove('hidden');
} else {
overlay.classList.add('hidden');
}
});
localStorage.setItem('highlighterEnabled', highlighterEnabled ? 'true' : 'false');
});
const savedHighlighterState = localStorage.getItem('highlighterEnabled');
if (savedHighlighterState === 'false') {
highlighterEnabled = false;
highlighterToggle.checked = false;
}
zoomInButton.addEventListener('click', () => {
if (zoomLevel < maxZoom) {
zoomLevel += zoomStep;
updateZoom();
}
});
zoomOutButton.addEventListener('click', () => {
if (zoomLevel > minZoom) {
zoomLevel -= zoomStep;
updateZoom();
}
});
function updateZoom() {
zoomValueDisplay.textContent = `${zoomLevel}%`;
const containers = document.querySelectorAll('.page-container');
const zoomScale = zoomLevel / 100;
containers.forEach((container, index) => {
container.style.transform = `scale(${zoomScale})`;
container.style.transformOrigin = 'top center';
if (index < containers.length - 1) {
const originalHeight = container.offsetHeight;
const scaledHeight = originalHeight * zoomScale;
const marginAdjustment = originalHeight - scaledHeight;
container.style.marginBottom = `${16 - marginAdjustment}px`;
}
});
}
document.getElementById('pdf-file').addEventListener('change', handlePdfUpload);
document.getElementById('mp3-file').addEventListener('change', handleMp3Upload);
document.getElementById('json-file').addEventListener('change', handleJsonUpload);
audioPlayer.addEventListener('timeupdate', handleTimeUpdate);
speedSlider.addEventListener('input', handleSpeedChange);
const toggleButton = document.getElementById('toggle-button');
const toggleText = document.getElementById('toggle-text');
const sidebar = document.getElementById('sidebar');
let isCollapsed = false;
if (toggleButton) {
toggleButton.addEventListener('click', () => {
isCollapsed = !isCollapsed;
if (isCollapsed) {
sidebar.classList.add('collapsed');
toggleText.textContent = '⌄ Hide Controls';
} else {
sidebar.classList.remove('collapsed');
toggleText.textContent = '⌃ Show Controls';
}
});
}
function handlePdfUpload(e) {
const file = e.target.files[0];
if (!file) return;
document.getElementById('pdf-file-name').textContent = file.name;
viewerPlaceholder.style.display = 'none';
showStatus('Rendering PDF pages...', true);
pageViewports = {};
inferredPageDims = {};
currentUserPage = null;
currentAudioPage = null;
if (intersectionObserver) intersectionObserver.disconnect();
const fileReader = new FileReader();
fileReader.onload = function() {
const typedarray = new Uint8Array(this.result);
const loadingTask = pdfjsLib.getDocument(typedarray);
loadingTask.promise.then(pdf => {
pdfDoc = pdf;
fileTracker.pdf = true;
pdfContainer.innerHTML = '';
renderAllPages();
}).catch(err => {
showStatus('Error loading PDF: ' + err.message, false, true);
console.error('PDF Load Error:', err);
});
};
fileReader.readAsArrayBuffer(file);
}
function handleMp3Upload(e) {
const file = e.target.files[0];
if (!file) return;
document.getElementById('mp3-file-name').textContent = file.name;
if (audioPlayer.src && audioPlayer.src.startsWith('blob:')) {
URL.revokeObjectURL(audioPlayer.src);
}
const url = URL.createObjectURL(file);
audioPlayer.src = url;
fileTracker.mp3 = true;
checkAllFilesLoaded();
}
function handleJsonUpload(e) {
const file = e.target.files[0];
if (!file) return;
document.getElementById('json-file-name').textContent = file.name;
const fileReader = new FileReader();
fileReader.onload = function() {
try {
const data = JSON.parse(this.result);
if (data && data.sentences && Array.isArray(data.sentences)) {
manifest = data.sentences;
inferLayoutDimensions(manifest);
fileTracker.json = true;
checkAllFilesLoaded();
} else {
showStatus('Invalid JSON: Missing "sentences" array', false, true);
}
} catch (err) {
showStatus('Error parsing JSON file', false, true);
console.error('JSON Parse Error:', err);
}
};
fileReader.readAsText(file);
}
function handleSpeedChange(e) {
const speed = parseFloat(e.target.value);
if (audioPlayer && !isNaN(speed)) {
audioPlayer.playbackRate = speed;
speedValueDisplay.textContent = `${speed.toFixed(1)}x`;
}
}
function inferLayoutDimensions(sentences) {
inferredPageDims = {};
if (!sentences || sentences.length === 0) return;
sentences.forEach(sentence => {
const loc = sentence.location;
if (!loc || !loc.page_number || !loc.points || !Array.isArray(loc.points) || loc.points.length === 0) return;
const pageNum = loc.page_number;
if (!inferredPageDims[pageNum]) {
inferredPageDims[pageNum] = { maxX: 0, maxY: 0 };
}
loc.points.forEach(point => {
if (Array.isArray(point) && point.length >= 2) {
if (typeof point[0] === 'number' && point[0] > inferredPageDims[pageNum].maxX) {
inferredPageDims[pageNum].maxX = point[0];
}
if (typeof point[1] === 'number' && point[1] > inferredPageDims[pageNum].maxY) {
inferredPageDims[pageNum].maxY = point[1];
}
}
});
});
console.log("Inferred Page Dimensions:", inferredPageDims);
}
function checkAllFilesLoaded() {
if (fileTracker.pdf && fileTracker.mp3 && fileTracker.json) {
showStatus('Ready to play!', false, false);
audioPlayer.disabled = false;
const initialSpeed = parseFloat(speedSlider.value) || 1.0;
audioPlayer.playbackRate = initialSpeed;
speedValueDisplay.textContent = `${initialSpeed.toFixed(1)}x`;
updatePageDisplays();
setTimeout(() => {
statusBox.style.display = 'none';
}, 2000);
} else {
let missing = [];
if (!fileTracker.pdf) missing.push('PDF');
if (!fileTracker.mp3) missing.push('MP3');
if (!fileTracker.json) missing.push('JSON');
showStatus('Waiting for: ' + missing.join(', '), true, false);
currentAudioPage = null;
currentUserPage = null;
updatePageDisplays();
}
}
async function renderAllPages() {
if (!pdfDoc) return;
const numPages = pdfDoc.numPages;
showStatus(`Rendering ${numPages} page${numPages > 1 ? 's' : ''}...`, true, false);
for (let i = 1; i <= numPages; i++) {
const page = await pdfDoc.getPage(i);
pageViewports[i] = page.getViewport({ scale: 1.0 });
const viewport = page.getViewport({ scale: pdfScale });
const pageContainer = document.createElement('div');
pageContainer.id = `page-container-${i}`;
pageContainer.className = 'page-container';
pageContainer.style.width = `${viewport.width}px`;
pageContainer.style.height = `${viewport.height}px`;
pageContainer.dataset.pageNumber = i;
const canvas = document.createElement('canvas');
canvas.id = `pdf-canvas-${i}`;
canvas.width = viewport.width;
canvas.height = viewport.height;
const highlightOverlay = document.createElement('div');
highlightOverlay.id = `highlight-overlay-${i}`;
highlightOverlay.className = 'highlight-overlay';
if (!highlighterEnabled) {
highlightOverlay.classList.add('hidden');
}
pageContainer.appendChild(canvas);
pageContainer.appendChild(highlightOverlay);
pdfContainer.appendChild(pageContainer);
const renderContext = {
canvasContext: canvas.getContext('2d'),
viewport: viewport
};
try {
await page.render(renderContext).promise;
} catch (err) {
console.error(`Error rendering page ${i}:`, err);
}
}
setupIntersectionObserver();
checkAllFilesLoaded();
}
function setupIntersectionObserver() {
const options = {
root: document.getElementById('pdf-viewer'),
rootMargin: '0px',
threshold: 0.5
};
intersectionObserver = new IntersectionObserver(handleIntersection, options);
document.querySelectorAll('.page-container').forEach(pageEl => {
intersectionObserver.observe(pageEl);
});
}
function handleIntersection(entries) {
entries.forEach(entry => {
if (entry.isIntersecting) {
const newPage = parseInt(entry.target.dataset.pageNumber, 10);
if (newPage !== currentUserPage) {
currentUserPage = newPage;
updatePageDisplays();
}
}
});
}
function handleTimeUpdate() {
if (!manifest || audioPlayer.paused) return;
const currentTime = audioPlayer.currentTime;
const sentence = findSentenceForTime(currentTime);
if (sentence) {
const newPage = sentence.location?.page_number;
if (newPage && newPage !== currentAudioPage) {
currentAudioPage = newPage;
updatePageDisplays();
}
if (sentence.i !== currentHighlightSentence) {
currentHighlightSentence = sentence.i;
if (highlighterEnabled) {
drawHighlight(sentence);
}
}
}
}
function findSentenceForTime(time) {
return manifest.find(s => time >= s.start && time < s.end);
}
function drawHighlight(sentence) {
if (currentHighlight) {
currentHighlight.remove();
currentHighlight = null;
}
const loc = sentence.location;
if (!loc || !loc.page_number || !loc.points) return;
const coords = loc.points;
if (!Array.isArray(coords) || coords.length < 3 ||
!Array.isArray(coords[0]) || coords[0].length < 2 ||
!Array.isArray(coords[2]) || coords[2].length < 2) return;
const y_min_raw = coords[0][1];
const y_max_raw = coords[2][1];
if (typeof y_min_raw !== 'number' || typeof y_max_raw !== 'number' || y_max_raw <= y_min_raw) return;
const pageNum = loc.page_number;
const overlay = document.getElementById(`highlight-overlay-${pageNum}`);
const canvas = document.getElementById(`pdf-canvas-${pageNum}`);
const inferredDims = inferredPageDims[pageNum];
if (!overlay || !canvas || !inferredDims || !inferredDims.maxY) return;
const normHeight = inferredDims.maxY;
const canvasHeight = canvas.height;
const norm_y_min = y_min_raw / normHeight;
const norm_y_max = y_max_raw / normHeight;
const clamped_norm_y_min = Math.max(0, Math.min(1, norm_y_min));
const clamped_norm_y_max = Math.max(0, Math.min(1, norm_y_max));
const final_y = clamped_norm_y_min * canvasHeight;
const final_height = (clamped_norm_y_max - clamped_norm_y_min) * canvasHeight;
const box = document.createElement('div');
box.className = 'highlight-box';
box.style.top = `${final_y}px`;
box.style.height = `${final_height}px`;
overlay.appendChild(box);
currentHighlight = box;
}
function showStatus(message, isLoading, isError) {
statusBox.style.display = 'flex';
statusMessage.textContent = message;
loadingSpinner.style.display = isLoading ? 'inline-block' : 'none';
if (isError) {
statusBox.className = 'status-box status-error';
} else if (isLoading) {
statusBox.className = 'status-box status-loading';
} else {
statusBox.className = 'status-box status-success';
}
}
function updatePageDisplays() {
const totalPages = pdfDoc ? pdfDoc.numPages : '-';
const reading = currentAudioPage ?? '-';
const viewing = currentUserPage ?? '-';
audioPageDisplay.innerHTML = `📖 Reading: <span class="page-number">${reading} / ${totalPages}</span>`;
userPageDisplay.innerHTML = `👁️ Viewing: <span class="page-number">${viewing} / ${totalPages}</span>`;
}
let lastTouchEnd = 0;
document.addEventListener('touchend', (event) => {
const now = Date.now();
if (now - lastTouchEnd <= 300) {
event.preventDefault();
}
lastTouchEnd = now;
}, false);
document.addEventListener('gesturestart', (e) => e.preventDefault());
document.addEventListener('gesturechange', (e) => e.preventDefault());
document.addEventListener('gestureend', (e) => e.preventDefault());
let orientationChangeTimeout;
window.addEventListener('orientationchange', () => {
clearTimeout(orientationChangeTimeout);
orientationChangeTimeout = setTimeout(() => {
console.log('Orientation changed');
}, 100);
});
console.log('✅ PDF Audio Player loaded with highlighter toggle!');
</script>
</body>
</html>